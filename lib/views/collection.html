{% block title %}{{ collectionName }}{% endblock %}

{% if collapsibleJSON %}
$(function() {
  // convert all objects to renderjson elements
  $('div.tableContent pre').each(function() {
    var text = $.trim($(this).text());

    if (text) {
      $(this).html(renderjson(JSON.parse(text)));
    }
  });
});
renderjson.set_show_to_level({{ collapsibleJSONDefaultUnfold }});
{% endif %}
</script>

  {% if documents.length == 0 %}
    <p class="well">
      No documents found.
    </p>
  {% else %}
  
  <!-- pager (first, prev, next, last) -->
  {% if pagination %}
    <ul class="pager span7">
      <li class="previous"><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip=0&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">&larr; First</a></li>
      <li{% if prev.skip < 0 %} class="disabled"{% endif %}>
        <a{% if prev.skip >= 0 %} href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ prev.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}"{% endif %}>&larr; Prev</a>
      </li>

      <li{% if next.skip >= stats.count %} class="disabled"{% endif %}>
        <a{% if next.skip < stats.count %} href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ next.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}"{% endif %}>Next &rarr;</a>
      </li>

      <li class="next"><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ last }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">Last &rarr;</a></li>
    </ul>
  {% endif %}

  <!-- CREATES TABLE FOR ALL DOCUMENTS -->
  <div class="fadeToWhite" id="fadeToWhiteID"></div>
  <div class="table-responsive tableWrapper">
    <table class="table table-striped tableHeaderFooterBars">
      <thead>
        {% for column in columns %}
          <th>{{column}}</th>
        {% endfor %}
      </thead>
      {% for document in docs %}
        <tr onclick="loadDocument('{{ document._id | json | safe | url_encode }}')">
          {% for column in columns %}
            <td><div class="tableContent">
              {% if !settings.read_only && column === '_id' && collectionName !== 'system.indexes' %}
                <form method="POST" style="display:inline;" action="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}/{{ document._id | json | safe | url_encode }}?skip={{ skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">
                <input type="hidden" name="_method" value="delete">
                <button type="submit" class="btn btn-danger">
                <span class="glyphicon glyphicon-trash"></span>
                </button>
                </form>
              {% endif %}
            {{ document[column] | stringDocIDs | to_display | safe }}
            </div></td>
          {% endfor %}
        </tr>
      {% endfor %}
    </table>
  </div>
  
  <!-- pagination below table (1, 2, 3, ..., x) -->
  {% if pagination %}
    <nav>
      <div class="text-center">
      <ul class="pagination">
        {%- if prev2.skip >= 0 %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ prev2.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">{{ prev2.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {%- endif %}

        {%- if prev.skip >= 0 %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ prev.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">{{ prev.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {%- endif %}

        <li class="active"><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">{{ here }}</a></li>

        {%- if next.skip < stats.count %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ next.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">{{ next.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {% endif %}

        {%- if next2.skip < stats.count %}
        <li><a href="{{ baseHref }}db/{{ dbName }}/{{ collectionName }}?skip={{ next2.skip }}&key={{ key }}&value={{ value }}&type={{ type }}&query={{ query }}&projection= {{ projection }}">{{ next2.page }}</a></li>
        {% else %}
        <li><a>&nbsp;</a></li>
        {% endif %}
      </ul>
      </div>
    </nav>
  {% endif %}

<script type="text/javascript">

function loadDocument(id) {
  location.href = '{{ baseHref }}db/{{ dbName }}/{{ collectionName }}/' + encodeURIComponent(id);
}

$(document).ready(function() {

  if ($('.tableHeaderFooterBars').width() === $('.tableWrapper').width()) {
    // table wrapper is the same width as the table itself, so not overflowing, so remove the white gradient
    $('.fadeToWhite').remove();
  } else {
    $('.fadeToWhite').height($('.tableWrapper').height()); // limit the height only to the table div
  }

  $('.deleteButton').tooltip({
    title: 'Are you sure you want to delete this collection? All documents will be deleted.',
  });

  $('.tableWrapper').scroll(function() {
    var proximityToRightOfTable = $('.tableWrapper table').width() - $('.tableWrapper').scrollLeft() - $('.tableWrapper').width();
    document.getElementById('fadeToWhiteID').style.opacity = Math.min(Math.max(proximityToRightOfTable - 50, 50) - 50, 100) / 100;
  });

  $('.tooDamnBig').bind('click', function(e) {
    e.preventDefault();
    e.stopPropagation();

    var target = $(this);
    var _id = target.attr('doc_id');
    var prop = target.attr('doc_prop');
    var spinner = '<img src="{{ baseHref }}images/gears.gif" />';
    var leftScroll = $('.tableWrapper').scrollLeft();

    // Set the element with spinner for now
    target.html(spinner);

    $.get('{{ baseHref }}db/{{ dbName }}/{{ collectionName }}/' + encodeURIComponent(_id) + '/' + prop, function(input) {

      // Images inline
      if (
        typeof input === 'string' &&
        (
          input.substr(0, 22) === 'data:image/png;base64,' ||
          input.substr(0, 22) === 'data:image/gif;base64,' ||
          input.substr(0, 22) === 'data:image/jpg;base64,' ||
          input.substr(0, 23) === 'data:image/jpeg;base64,'
        )
      )  {
        input = '<img src="' + input + '" style="max-height:100%; max-width:100%; "/>';
      }

      // Audio inline
      if (
        typeof input === 'string' &&
        (
          input.substr(0, 22) === 'data:audio/ogg;base64,' ||
          input.substr(0, 22) === 'data:audio/mp3;base64,'
        )
      )  {
        input = '<audio controls style="width:45px;" src="' + input + '">Your browser does not support the audio element.</audio>';
      }

      // Video inline
      if (
        typeof input === 'string' &&
        (
          input.substr(0, 23) === 'data:video/webm;base64,' ||
          input.substr(0, 22) === 'data:video/mp4;base64,'  ||
          input.substr(0, 22) === 'data:video/ogv;base64,'
        )
      )  {
        input = '<video controls><source type="' + input.substring(input.indexOf(':') + 1, input.indexOf(';')) + '" src="' + input + '"/>' +
          'Your browser does not support the video element.</video>';
      }

      if (typeof input === 'object' && (input.toString() === '[object Object]' || input.toString().substr(0,7) === '[object')) {
        input = renderjson(input);
      }

      // Set the element with gotten datas
      target.parent().html(input);

      // Set original scroll position
      $('.tableWrapper').scrollLeft(leftScroll);
    });
  });
});
</script>
